---
title: BBtools
description: A suite of command line utilities for sequence quality control, mapping, assembly, and kmer based analysis
permalink: /guide/bbtools/
author: Jordan Hoosman
layout: page
---

<style>
/* Page styling */
.vbar {
	border-left: 5px solid lightgrey;
	padding-left: 10px;
}
.hbar1 {
	background-color: lightgrey;
	width: 100%;
	height: 1px;	
}
.hbar2 {
	background-color: lightgrey;
	width: 100%;
	height: 5px;	
}

/*** Text styling ***/
.rtext {
	background-color: rgba(255, 0, 0, .05);
	color: rgb(255, 0, 50);
}
.rtext2 {
	color:rgb(250, 5, 100);
}

.gtext {
	color: rgb(180, 180, 180);
}
.otext {
	color: rgb(255, 135, 0);
}
/*** Div styling ***/
.gbox {
	background-color: rgb(245, 245, 245);
	box-shadow: 1px;
	padding-left: 25px;
	padding-top: 5px;
	padding-bottom: 5px;
}
.gbox * {
	margin: 0;
}
/*** Other ***/
.tab1 {
	margin-left: 25px;
	margin-top: 0;
}
.tab2 {
	margin-left: 50px;
	margin-top: 0;
}

.removemargins_tb p {
	margin-top: 0;
	margin-bottom: 0;
}
</style>

<div class="hbar1"></div>

### A suite of command line utilities for sequence quality control, mapping, assembly, and kmer based analysis

##### Written by Brian Bushnell.

As the BBtools website describes it:

<div class="vbar">
	<p>BBTools is a suite of fast, multithreaded bioinformatics tools designed for analysis of DNA and RNA sequence data. BBTools can handle common sequencing file formats such as fastq, fasta, sam, scarf, fasta+qual, compressed or raw, with autodetection of quality encoding and interleaving. It is written in Java and works on any platform supporting Java, including Linux, MacOS, and Microsoft Windows and Linux; there are no dependencies other than Java (version 7 or higher). Program descriptions and options are shown when running the shell scripts with no parameters</p>
</div>
<div class="vbar">
	<p>BBTools is open source and free for unlimited use, and is used regularly by DOE JGI and other institutions around the world.</p>
</div>
<div class="vbar">
	<p>The BBTools suite includes programs such as: </p>
	<pre>
• bbduk – filters or trims reads for adapters and contaminants using k-mers 
• bbmap – short-read aligner for DNA and RNA-seq data 
• bbmerge – merges overlapping or nonoverlapping pairs into a single reads 
• reformat – converts sequence files between different formats such as fastq and fasta
	</pre>
</div>

For more information see the <a href="http://jgi.doe.gov/data-and-tools/bbtools/">BBtools website</a> and the <a href="http://jgi.doe.gov/data-and-tools/bbtools/bb-tools-user-guide">BBtools user guide</a>. Support is available from a number of threads at the <a href="http://seqanswers.com/forums/showthread.php?t=41057">SeqAnswers</a> site. A listing of those threads is provided <a href="http://jgi.doe.gov/data-and-tools/bbtools/bbtools-faq-support-forums/">here</a>.

The package contains 125 scripts and programs but this examples folder highlights some of the most common use cases.

<div class="hbar2"></div>

### Directory contents

<div class="hbar1"></div>

<div class="removemargins_tb">
	<p>1. <span class="rtext">bbmap_examples</span> - A directory with bbmap examples</p>
	<p class="tab1">•  <span class="rtext">basic_mapping</span> - A directory with a shell script that generates an index then maps reads to the index</p>
	<p class="tab2">○  <span class="rtext">bbmap_basic_mapping.sh</span> - example shell script</p>
	<p class="tab2">○  <span class="rtext">results</span> - Data files generated by this analysis will be placed in this directory. This format is used in otherexamples</p>
	<p>2. <span class="rtext">bbduk_examples</span> - A directory with examples of BBDuk</p>
	<p class="tab1">•  <span class="rtext">adaptor_trimming</span> - A directory with a shell script that trims sequencing adaptors from fastq formatted reads</p>
	<p class="tab2">○  <span class="rtext">bbduk_adaptor_trimming.sh</span> - example shell script</p>
	<p class="tab1">•  <span class="rtext">quality_trimming</span> - A directory with a shell script that trims low quality bases</p>
	<p class="tab2">○  <span class="rtext">bbduk_quality_trimming.sh</span> - example shell script</p>
	<p class="tab1">•  <span class="rtext">kmer filtering</span> - A directory with a shell script that removes reads containing kmers from a reference. Often usedto remove PhiX spike-in sequences that have made it past Illumina barcode based removal.</p>
	<p class="tab2">○  <span class="rtext">bbduk_kmer_filtering.sh</span> - example shell script</p>
	<p class="tab1">•  <span class="rtext">histogram_generation</span> - A directory with a shell script that generates quality histograms</p>
	<p class="tab2">○  <span class="rtext">bbduk_histogram_generation.sh</span> - example shell script</p>
	<p>3. <span class="rtext">bbmerge_examples</span> - A directory containing examples for the multithreaded read-merging tool bbmerge</p>
	<p class="tab1">•  <span class="rtext">basic_merging</span> - A directory with a shell script that merges overlapping reads and creates an insert size histogram</p>
	<p class="tab2">○  <span class="rtext">bbmerge_basic_merging.sh</span> - example shell script</p>
	<p class="tab1">•  <span class="rtext">error_correction</span> - A directory with a shell script that corrects sequencing errors by mate-pair overlap then returnsthe reads unmerged</p>
	<p class="tab2">○  <span class="rtext">bbmerge_error_correction.sh</span>- example shell scripts</p>
</div>

### Running notes

<div class="removemargins_tb">
	<p>• For simplicity I have created the script <span class="rtext">env.sh</span> that creates the top level path directory ($bbtoolsExamplesDir). By sourcing this file <span class="rtext">source env.sh</span> you can run the example scripts from different directories.</p>
	<p>• <span class="rtext">setup.sh</span> is a maintenance script that can be used with the <span class="rtext">build</span> or <span class="rtext">clean</span> option to run all examples and placethe data into the results directories or delete all data from the results directories.</p>
	<p>• If an example script is run individually, progress and statistics will be written to the screen through the standard errorstream. That output can be seen in the <span class="rtext">terminaloutput.txt</span> file of the <span class="rtext">results</span> directory</p>
</div>

<div class="hbar2"></div>

### Detailed tutorial instructions

<div class="hbar1"></div>

Since we are going to be running computations lets request an interactive node from the job scheduling system. ```bash <span class="rtext">srun --pty -p short -t 01:00:00 -n 16 -N 1 /bin/bash -I</span>

<div class="gbox">
	<p>You can begin exploring the functionality of BBtools by copying the exampledirectory into your own home directory:</p>
	<p>```bash</p>
	<p>cp -r /scinet01/gov/usda/ars/scinet/project/training_files/bbtools "$HOME"</p>
</div>

From there you can examine the output of the results directories for each example. These results are also available at the original location for reference.

First, start by "sourcing" the <span class="rtext">env.sh</span> script. Doing this this sets up a variable called <span class="rtext">$bbtoolsExamplesDir</span> that tells the example scripts where the bbtools examples directory is located.

<div class="gbox">
	<p>source env.sh</p>
</div>

Since we are going to be running these example scripts one-by-one lets remove all the data that is currently in the results directories. Running a helper script can accomplish this easily for you

<div class="gbox">
	<p>./setup.sh clean</p>
</div>

##### Trimming adapters

A typical workflow for processing Illumina sequencing data takes the demultiplexed data from the sequencer and perform a series of trimming and contaminant removal steps. The first step is usually to remove adaptor sequences. These adaptors sometimes occur in sequences because the insert size is less than read length and the sequencer reads through to the other side.

This can be accomplished by running this script.

<div class="gbox">
	<p>bbduk_examples/adaptor_trimming/bbduk_adaptor_trimming.sh</p>
</div>

Lets look at the contents of that script.

First it checks for the environment variable <span class="rtext">$bbtoolsExamplesDir</span>

<div class="gbox">
	<p class="gtext"># Check that the bbtools example directory variable has been set for users</p>
	<p>[[ -e <span class="otext">"$bbtoolsExamplesDir"</span> ]] || { echo >&2 <span class="otext">"Please source the env.sh file \</span></p>
	<p><span class="otext">(source env.sh) in the bbtools example directory before running this script"</span>; exit 1;}</p>
</div>

Then it loads bbtools from the module management system of CERES

<div class="gbox">
	<p class="gtext"># Load the bbtools module</p>
	<p> module load bbtools</p>
</div>

<p>Finally it runs <span class="rtext">bbduk.sh</span>, a program in the bbtools suite:</p>

<!-- Idividual <p> tags didn't work in this div, someone pls help -->
<!-- coding is dumb :( -->
<div class="gbox">
	<p>
		<span class="gtext"># Trim the adapters using the reference file adaptors.fa (provided by bbduk)</span><br>
		bbduk.sh <span class="rtext2">in</span>=<span class="otext">"$bbtoolsExamplesDir"</span>/data/reads.fq.gz \<br>
		out=<span class="otext">"$bbtoolsExamplesDir"</span>/bbduk_examples/adaptor_trimming/results/clean.fq.gz \<br>
		ref=<span class="otext">"$bbtoolsExamplesDir"</span>/data/adapters.fa \<br>
		ktrim=r k=23 mink=11 hdist=1 tbo=t
	</p>
</div>

<p><span class="rtext">bbduk.sh</span> can read and write compressed or uncompressed formats and infers the format from the file extension youprovide it.</p>

<div class="tab1 removemargins_tb" >
	<p>• <span class="rtext">in=</span> the fastq file to trim</p>
	<p>• <span class="rtext">out=</span> the fastq file to output</p>
	<p>• <span class="rtext">ref=</span> points to a file with the reference sequences to be removes.</p>
	<p>• <span class="rtext">ktrim=r</span> lets bbduk know to trim off the 3' end of each read.</p>
	<p>• <span class="rtext">k=23</span> sets the length of the kmer to find</p>
	<p>• <span class="rtext">mink=11</span> specifies that kmers as short as 11 bases on the ends can be trimmed too</p>
	<p>• <span class="rtext">hdist=1</span> sets the Hamming distance i.e. the number of mismatches allowed in the kmer</p>
	<p>• <span class="rtext">tbo=t</span> trims adaptors based on where they are paired</p>
</div>

This will write out a fastq file with adaptors trimmed off.

##### Kmer filtering for contaminant sequence removal

The next step in quality control is often to remove reads with other contaminants. Typically the file generated from adaptor trimming will be run through bbduk in contaminant filtering mode to remove common lab contaminants like phiX174. For simplicity, this example will use the original input file though, not the output of adaptor trimming.

Run the kmer filtering script.

<div class="gbox">
	<p>bbduk_examples/kmer_filtering/bbduk_kmer_filtering.sh</p>
</div>

This calls bbduk.sh with these parameters.

<div class="gbox">
	<p>
		<span class="gtext"># Filter out PhiX containing reads optionally placing them in their own file</span><br>
		bbduk.sh <span class="rtext2">in</span>=<span class="otext">"$bbtoolsExamplesDir"</span>/data/reads.fq.gz \<br>
		out=<span class="otext">"$bbtoolsExamplesDir"</span>/bbduk_examples/kmer_filtering/results/unmatched.fq.gz \<br>
		outm=<span class="otext">"$bbtoolsExamplesDir"</span>/bbduk_examples/kmer_filtering/results/matched.fq.gz \<br>
		ref=<span class="otext">"$bbtoolsExamplesDir"</span>/data/phix174_ill.ref.fa.gz \<br>
		k=31 hdist=1 stats=<span class="otext">"$bbtoolsExamplesDir"</span>/bbduk_examples/kmer_filtering/results/stats.txt
	</p>
</div>

The options are:

<div class="tab1 removemargins_tb">
	<p>• <span class="rtext">out=</span>the fastq file containing reads that matched the contaminant database (sometimes used to estimate error rates in the data).</p>
	<p>• <span class="rtext">outu=</span>the primary fastq file with all contaminant reads removed</p>
	<p>• <span class="rtext">ref=</span>the fasta file(s) with all the contaminants to be removed. In this case it is just PhiX174, but other contaminant references can be added. Long contaminant genomes (plants and animals) are better removed with bbmap.</p>
	<p>• <span class="rtext">k=31</span>sets the length of the kmer to find</p>
	<p>• <span class="rtext">hdist=1</span>sets the Hamming distance i.e. the number of mismatches allowed in the kmer</p>
	<p>• <span class="rtext">stats=</span>the file to write statistics about what contaminants were found in the data</p>
</div>

##### Quality trimming

BBduk can perform hard quality trimming. Quality trimming was a pretty standard preprocessing step a few years ago but now the decsion to use it depends on the downstream workflow. Some merging, error correction mapping and assembly methods can use, correct or ignore low quality bases.

Run the adaptor trimming script.

<div class="gbox">
	<p>bbduk_examples/quality_trimming/bbduk_quality_trimming.sh</p>
</div>

This calls bbduk.sh with these parameters.

<div class="gbox">
	<p># Trim reads with a quality score of less than 10 from the right side of reads</p>
	<p>bbduk.sh <span class="rtext2">in</span>=<span class="otext">"$bbtoolsExamplesDir"</span>/data/reads.fq.gz \</p>
	<p>out=<span class="otext">"$bbtoolsExamplesDir"</span>/bbduk_examples/quality_trimming/results/clean.fq.gz \</p>
	<p>qtrim=r trimq=10</p>
</div>

The parameters are pretty simple for this process.

<div class="tab1 removemargins_tb">
	<p>• <span class="rtext">qtrim=r</span> trim the reads from the right (3') end(s)</p>
	<p>• <span class="rtext">trimq=10</span> trim bases with a quality score below 10</p>
</div>

##### Histogram generation

BBduk will generate histogram data for a number of quality metrics. Most of these reports can be generated during another step like adaptor trimming. This example generates many of these reports in one run.

Run the histogram generation script.

<div class="gbox">
	<p>bbduk_examples/histogram_generation/bbduk_histogram_generation.sh</p>
</div>

This calls bbduk.sh with these parameters.

<div class="gbox">
	<p>bbduk.sh <span class="rtext2">in</span>=<span class="otext">"$bbtoolsExamplesDir"</span>/data/reads.fq.gz \</p>
	<p>bhist=<span class="otext">"$bbtoolsExamplesDir"</span>/bbduk_examples/histogram_generation/results/bhist.txt \</p>
	<p>qhist=<span class="otext">"$bbtoolsExamplesDir"</span>/bbduk_examples/histogram_generation/results/qhist.txt \</p>
	<p>gchist=<span class="otext">"$bbtoolsExamplesDir"</span>/bbduk_examples/histogram_generation/results/gchist.txt \</p>
	<p>aqhist=<span class="otext">"$bbtoolsExamplesDir"</span>/bbduk_examples/histogram_generation/results/aqhist.txt \</p>
	<p>bqhist=<span class="otext">"$bbtoolsExamplesDir"</span>/bbduk_examples/histogram_generation/results/bqhist.txt \</p>
	<p>lhist=<span class="otext">"$bbtoolsExamplesDir"</span>/bbduk_examples/histogram_generation/results/lhist.txt \</p>
	<p>gchist=<span class="otext">"$bbtoolsExamplesDir"</span>/bbduk_examples/histogram_generation/results/gchist.txt \</p>
	<p>gcbins=auto</p>
</div>

Each option generates the following histogram data files:

<div class="tab1 removemargins_tb">
	<p>• <span class="rtext">bhist=</span>base composition histogram by position</p>
	<p>• <span class="rtext">qhist=</span>quality histogram by position</p>
	<p>• <span class="rtext">qchist=</span>count of bases with each quality value</p>
	<p>• <span class="rtext">aqhist=</span>histogram of average read quality</p>
	<p>• <span class="rtext">bqhist=</span>quality histogram designed for box plots</p>
	<p>• <span class="rtext">lhist=</span>read length histogram</p>
	<p>• <span class="rtext">gchist=</span>read GC content histogram</p>
</div>

##### Merging reads

For some applications like assembly, merging reads can reduce the memory required and reduce assembly errors. Running merging also produces an estimate of the read-pair insert size which can help the lab optimize their fragmentation and library creation methods.

Run the basic read merging script.

<div class="gbox">
	<p>bbmerge_examples/basic_merging/bbduk_basic_merging.sh</p>
</div>

This calls bbmerge.sh with these parameters.

<div class="gbox">
	<p>bbmerge.sh <span class="rtext2">in</span>=<span class="otext">"$bbtoolsExamplesDir"</span>/data/reads.fq.gz \</p>
	<p>out=<span class="otext">"$bbtoolsExamplesDir"</span>/bbmerge_examples/basic_merging/results/merged.fq.gz \</p>
	<p>outu=<span class="otext">"$bbtoolsExamplesDir"</span>/bbmerge_examples/basic_merging/results/unmerged.fq.gz \</p>
	<p>ihist=<span class="otext">"$bbtoolsExamplesDir"</span>/bbmerge_examples/basic_merging/results/ihist.txt \</p>
	<p>usejni</p>
</div>

The parameters are:

<div class="tab1 removemargins_tb">
	<p>• <span class="rtext">out=</span> A fastq file with the reads the were successfully merged</p>
	<p>• <span class="rtext">outu=</span> A fastq file with the read pairs that could not be merged</p>
	<p>• <span class="rtext">ihist=</span> An insert size histogram file</p>
	<p>• <span class="rtext">usejni=</span> An option to use the "Java Native Interface (jni)" to call compiled routines in C++. This speeds up merging.The option is available in CERES.</p>
</div>

##### Merging for error correction

Overlapping reads can be used to correct sequencing errors on the ends of the read pairs.

Run the histogram generation script.

<div class="gbox">
	<p>bbmerge_examples/basic_merging/bbduk_error_correction.sh</p>
</div>

This calls bbmerge.sh with these parameters.

<div class="gbox">
	<p>bbmerge.sh <span class="rtext2">in</span>=<span class="otext">"$bbtoolsExamplesDir"</span>/data/reads.fq.gz \</p>
	<p>out=<span class="otext">"$bbtoolsExamplesDir"</span>/bbmerge_examples/error_correction/results/corrected.fq.gz \</p>
	<p>ecco mix usejni</p>
</div>

The parameters are:

<div class="tab1 removemargins_tb">
	<p>• <span class="rtext">out=</span> The error-corrected merged reads</p>
	<p>• <span class="rtext">ecco</span> The flag to perform error correction but not merge the reads</p>
	<p>• <span class="rtext">mix</span> The flag to output the corrected and uncorrected reads into the same file</p>
	<p>• <span class="rtext">usejni</span>An option to use the "Java Native Interface (jni)" to call compiled routines in C++. This speeds up merging. The option is available in CERES.</p>
</div>

##### Mapping Reads to a reference with bbmap

The reads in this tutorial come from a mock viral metagenome with isolate virus DNA mixed together. The reference database <span class="rtext">Ref_database.fq.gz</span> used for mapping has those reference viral genomes placed into one file.

Run the basic read merging script. This will build an index and map reads to it.

<div class="gbox">
	<p>bbmerge_examples/basic_merging/bbduk_basic_merging.sh</p>
</div>

This calls bbmerge.sh with these parameters. First it builds an index:

<div class="gbox">
	<p class="gtext"># Create a mapping index for the phage phiX174 and save it to disk \</p>
	<p class="gtext"># (you only need to do this once)</p>
	<p>bbmap.sh ref=<span class="otext">"$bbtoolsExamplesDir"</span>/data/Ref_database.fa.gz \</p>
	<p>path=<span class="otext">"$bbtoolsExamplesDir"</span>/bbmap_examples/basic_mapping/results \</span></p>
	usejni
</div>

Next, it maps the reads to the reference.

<div class="gbox">
	<p>bbmap.sh <span class="rtext2">in</span>=<span class="otext">"$bbtoolsExamplesDir"</span></p>
	<p>path=<span class="otext">"$bbtoolsExamplesDir"</span>/bbmap_examples/basic_mapping/results</p>
	<p>out=<span class="otext">"$bbtoolsExamplesDir"</span>/bbmap_examples/basic_mapping/results/mapped.sam</p>
	<p>usejni pigz unpigz maxindel=90</p>
</div>

The parameters are:

<div class="tab1 removemargins_tb">
	<p>• <span class="rtext">ref=</span> the reference sequence to map against</p>
	<p>• <span class="rtext">usejni</span> An option to use the "Java Native Interface (jni)" to call compiled routines in C++. This speeds up merging. The option is available in CERES.</p>
	<p>• <span class="rtext">pigz</span> and <span class="rtext">unpigz</span> perform parallel compression and uncompression</p>
	<p>• <span class="rtext">-Xmx4g</span> limits the amount of memory for this very small job (note the dash)</p>
	<p>• <span class="rtext">threads=</span>limits the threads for the example. You should match this to the number of threads requested my your SLURM job. by default bbtools grabs all available threads.</p>
	<p>• <span class="rtext">maxindel=90</span>sets the maximum gap between the read pairs. The default is 16k (for eukaryotic RNA) but this is notneeded for DNA</p>
</div>


